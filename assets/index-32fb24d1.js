import{p as J,S as M,z as W,v as G,A as K,D as X,E as Y,b as B,y as l,h as p,e as N,n as _,j as tt}from"./vendor-cf07880b.js";import{b as g,u as st,g as et,n as at,e as A,_ as it,a as E,c as rt,Z as nt,d as U,f as ct,T as q,s as ot}from"./index-6b0c52ca.js";var ht=Object.defineProperty,lt=Object.getOwnPropertyDescriptor,ut=(t,s,e,i)=>{for(var a=i>1?void 0:i?lt(s,e):s,r=t.length-1,n;r>=0;r--)(n=t[r])&&(a=(i?n(s,e,a):n(a))||a);return i&&a&&ht(s,e,a),a};class H extends M{constructor(s){super(),this.key="",this.key=s}save(){this.queue=[...this.queue],localStorage.setItem(this.key,JSON.stringify(this.queue))}}ut([J({value:[]})],H.prototype,"queue",2);const dt=7200*1e3;class ft{constructor(s){this.provider=st().bridgeStore.bridge.provider,this.store=new H(`evm.txs.${s||this.provider.account}`),this.checking=new Set,this.check(!0)}get queue(){return this.store.queue}async add(s){if(!s.chainId){const{network:e}=this.provider;s.chainId=e.chainId,s.scan=e.scan}s.pending=!0,this.queue.unshift(s),this.store.save(),this.provider.nonce=+s.nonce+1}delDelay(s,e=0){setTimeout(()=>this.del(s),e)}del(s){var i,a;const e=(a=(i=s.hash)!=null?i:s.ts)!=null?a:s;this.queue.some((r,n)=>{if([r.hash,r.ts,r].includes(e)){n===0&&(this.provider.nonce=0);const c=this.queue.splice(n,1);return this.store.save(),c}})}async check(s){this.queue.forEach(async(e,i)=>{if(s&&i===0){const a=await et(this.provider.account),r=+e.nonce;this.provider.nonce=r>a?r+1:a}if(e.done||new Date().getTime()-e.ts>=dt)return this.del(e);if(!e.err&&!(!s&&e.pending)){e.pending=!0;try{const a=await this.provider.provider.waitForTransaction(e.hash),{status:r}=a;e.status=r,r===1?(e.done=!0,this.del(e)):e.err=!0}catch(a){e.err=a}e.pending=!1}}),this.store.save()}}const L={},C=(t=g.bridge.account)=>L[t]||(L[t]=new ft(t)),gt=async t=>t?typeof t=="object"?t:await it(Object.assign({"./abi/Locker.codes.json":()=>E(()=>import("./Locker.codes-d3f42ed5.js"),[]),"./abi/Resolver.codes.json":()=>E(()=>import("./Resolver.codes-ee4f74d3.js"),[])}),`./abi/${t}.codes.json`):{};class R{constructor(s,{errorCodes:e="",seq:i=void 0,delay:a=0,allowAlmostSuccess:r=!1,onSent:n=()=>{}}={}){this.pending=!0,this.status=-1,this.allowAlmostSuccess=r,this.txPromise=s,this.err=void 0,this.hash="",this.errorCodes=e,this.seq=i,this.delay=a,this.onSent=n}get success(){return this.status===1}get almostSuccess(){return this.status===4}get ignored(){return this.status===3}async wait(s=!1){return(async()=>{let e=!1;const i=await gt(this.errorCodes);try{const a=await this.txPromise;this.onSent(a);const{hash:r,nonce:n}=a;this.seq.nonce=n,this.seq&&(delete this.seq.overrides,C().add(Object.assign(this.seq,{hash:r}))),this.hash=r,this.status=2;const c=async()=>{const{status:o,events:h}=await a.wait(1);if(o!==1)throw this.seq&&(this.seq.err=!0),new Error("Failed");h.some(({event:x,args:$}={})=>{if(x==="Failure"){let{info:y,detail:v,error:b}=$;const j=b.toString(),I=i[b],Z={code:j,message:I,error:b,info:y==null?void 0:y.toString(),detail:v==null?void 0:v.toString()};this.seq&&(this.seq.err=!0);const T=new Error(I);throw Object.assign(T,{code:j,raw:Z}),this.allowAlmostSuccess&&(this.status=4),T}}),this.status=1,this.seq&&(this.seq.done=!0),this.delay?C().delDelay(r,this.delay):C().del(r)};s?(e=!0,c()):await c()}catch(a){throw await at(a),a.code===4001?this.status=3:this.status!==4&&(this.status=0),this.err=a,a}finally{this.pending=!1;const a=this.status===1;A.emit("tx-status",this.hash),a&&A.emit("tx-success",this.hash),e=a}return e})()}}const S={A:2,B:4,C:6},d=t=>[t,S[t]],pt={"0x1":{"0x03783fac2efed8fbc9ad443e592ee30e61d65f471140c10ca155e937b435b760":d("A"),"0x1f675bff07515f5df96737194ea945c36c41e7b4fcef307b7cd4d0e602a69111":d("B"),"0x017e667f4b8c174291d1543c466717566e206df1bfd6f30271055ddafdb18f72":d("C")},"0xaa36a7":{"0x03783fac2efed8fbc9ad443e592ee30e61d65f471140c10ca155e937b435b760":d("A"),"0x1f675bff07515f5df96737194ea945c36c41e7b4fcef307b7cd4d0e602a69111":d("B"),"0x017e667f4b8c174291d1543c466717566e206df1bfd6f30271055ddafdb18f72":d("C")}},D=[64,130],V=async()=>(await ct()).bridge,m=async t=>t||(await V()).account,F=async()=>pt[(await V()).network.current.chainId],wt=async()=>Object.fromEntries(Object.entries(await F()).map(t=>[t[1][0],t[0]])),u=async t=>rt("Locker",{account:await m(t)}),P=t=>t.replace(/^0x/,""),O=t=>D[t.length<D[1]?0:1],mt=t=>(t=P(t),`0x${t.slice(0,O(t))}`),Q=t=>{t=P(t);const s=O(t);return t.slice(s,s+1).toUpperCase()},xt=t=>(t=P(t),parseInt(t.slice(O(t)+1,t.length)||"0",16)),$t=t=>{var s,e;return(e=S[(s=Q(t))!=null?s:"C"])!=null?e:S.C},jt=async t=>{t||(t=await m(t));const s=W(G("C"));let e="";return e=K(BigInt(t)^BigInt(s)),[e.replace("0x",""),"c","0"].join("")},It=async t=>await(await u()).nameExists(t),Tt=async(t,s=!1)=>(t||(t=await m()),await(await u(t))[s?"getUserPassesInfo":"getUserPassList"](t)),yt=async t=>{let s="";if(!t||t===nt)return s;const e=await u();try{s=await e.getNameByHash(X(t))}catch(i){}return s},At=async(t,s)=>{var r;const e=await u(s),i=await F();let a={id:t,cate:"C",len:6,name:""};try{const[n,c,o]=await e.getUserPassInfo(t),h=(r=i[c])!=null?r:Object.values(a);a={id:n,cate:h[0],hash:o,len:h[1],name:await yt(o)}}catch(n){}return a},Et=async(t,s="")=>{let{id:e,code:i,cate:a}=t;const r=!!e;e||(i=mt(t),a=(await wt())[Q(t)],e=xt(t));const n=await u(),c=r?"lockName":"lockPass",o={},h=r?[+e,s]:[i,s,a,+e];await U(o,n,c,h);const x=n[c](...h);return new R(x,{errorCodes:"Locker",allowAlmostSuccess:!0,seq:{type:r?"LockName":"lockPass",title:r?"Lock Name":"Lock Pass",ts:new Date().getTime(),overrides:o}})},Lt=async t=>{const s=await u(),[e,i]=["claimDoid",{}],a=[+t];await U(i,s,e,a);const r=s[e](...a);return new R(r,{errorCodes:"Locker",seq:{type:"claim",title:"Claim Name",ts:new Date().getTime(),overrides:i}})},Dt=async t=>{t||(t=await m());const e=await(await u(t)).getUserInvitedNumber(t);return Y(e[1],0)},vt="";var bt=Object.defineProperty,_t=Object.getOwnPropertyDescriptor,z=(t,s,e,i)=>{for(var a=i>1?void 0:i?_t(s,e):s,r=t.length-1,n;r>=0;r--)(n=t[r])&&(a=(i?n(s,e,a):n(a))||a);return i&&a&&bt(s,e,a),a};let k=class extends q(vt){constructor(){super(...arguments),this.bindBridge=new B(this,g)}get bridge(){return g.bridge}get txScanUri(){const{hash:t}=this.tx;return t?`${this.bridge.network.current.scan}/tx/${t}`:""}render(){return l`<dui-link class="uri mt-4" href="${this.txScanUri}" target="_blank" rel="noopener">View Transaction: ${ot(this.tx.hash)}</dui-link>`}};z([p({type:Object})],k.prototype,"tx",2);k=z([N("tx-view")],k);const Ct=`.tx-state{display:flex;flex-direction:column;align-items:center;flex-grow:1}.tx-state-icon.success{color:green}.tx-state-icon.failed{color:red}.tx-state-icon.warn{color:orange}.tx-state-msg{word-break:break-word;white-space:normal}
`;var St=Object.defineProperty,kt=Object.getOwnPropertyDescriptor,w=(t,s,e,i)=>{for(var a=i>1?void 0:i?kt(s,e):s,r=t.length-1,n;r>=0;r--)(n=t[r])&&(a=(i?n(s,e,a):n(a))||a);return i&&a&&St(s,e,a),a};let f=class extends q(Ct){constructor(){super(),this.bindBridge=new B(this,g),this.txType=!1,this.onlyAwaitHash=!1,this.opts={}}get bridge(){return g.bridge}get icons(){var a;const[t='<i class="mdi mdi-check-all"></i>',s='<i class="mdi mdi-check"></i>',e='<i class="mdi mdi-close"></i>',i='<i class="mdi mdi-loading"></i>']=(a=this.opts.icons)!=null?a:[];return{success:t,failed:e,wait:i,almostSuccess:s}}get hashOk(){return this.onlyAwaitHash&&this.tx.hash}get state(){var a,r,n;let[t,s,e]=["","",""];const{state:i}=this.opts;switch(this.tx.status){case-1:[t,s,e]=[this.icons.wait,(i==null?void 0:i.wait)||"Waiting for confirmation...","wait"];break;case 0:[t,s,e]=[this.icons.failed,(r=(a=this.tx.err)==null?void 0:a.message)!=null?r:"Something went wrong","failed"];break;case 1:[t,s,e]=[this.icons.success,(i==null?void 0:i.success)||"Success","success"];break;case 2:[t,s]=[this.icons.wait,"Confirm the transaction."];break;case 4:[t,s,e]=[this.icons.almostSuccess,((n=this.tx.err)==null?void 0:n.message)||"Almost Success","warn"];break}return this.hashOk&&([t,s,e]=[this.icons.success,(i==null?void 0:i.success)||"Success","success"]),{icon:t,txt:s,css:e}}get txScanUri(){const{hash:t}=this.tx;return t?`${this.bridge.network.current.scan}/tx/${t}`:""}render(){return l`<div class="tx-state m-4"><div class="tx-state-icon my-3 text-3xl mx-auto ${this.state.css}">${_(this.tx.pending&&!this.hashOk,()=>l`<slot name="pending"><i class="mdi mdi-loading"></i></slot>`,()=>l`<span>${tt(this.state.icon)}</span>`)}</div><div class="tx-state-msg my-4"><slot>${this.state.txt}</slot></div><div class="flex gap-4">${_(this.tx.hash,()=>l`${_(this.tx.success||this.tx.almostSuccess,()=>l`<slot name="view"><tx-view .tx="${this.tx}"></tx-view></slot>`,()=>l`<tx-view .tx="${this.tx}"></tx-view>`)}`)}</div></div>`}};w([p({type:Object})],f.prototype,"tx",2);w([p({type:Boolean})],f.prototype,"txType",2);w([p({type:Boolean})],f.prototype,"onlyAwaitHash",2);w([p({type:Object})],f.prototype,"opts",2);f=w([N("tx-state")],f);export{D as L,jt as a,At as b,It as c,Dt as d,Lt as e,u as f,$t as g,Tt as h,F as i,yt as j,Et as l};
