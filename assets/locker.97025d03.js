import{w as L,z as T,a as q,A as O,B as j,C as P,f as x,D as I,E as D,F as A,G as _,H as U,I as F}from"./index.3ded3a9c.js";var H=Object.defineProperty,M=Object.getOwnPropertyDescriptor,Q=(t,s,e,c)=>{for(var a=c>1?void 0:c?M(s,e):s,r=t.length-1,n;r>=0;r--)(n=t[r])&&(a=(c?n(s,e,a):n(a))||a);return c&&a&&H(s,e,a),a};class N extends T{constructor(s){super(),this.key="",this.key=s}save(){this.queue=[...this.queue],localStorage.setItem(this.key,JSON.stringify(this.queue))}}Q([L({value:[]})],N.prototype,"queue",2);const R=7200*1e3;class z{constructor(s){this.provider=O().bridgeStore.bridge.provider,this.store=new N(`evm.txs.${s||this.provider.account}`),this.checking=new Set,this.check(!0)}get queue(){return this.store.queue}async add(s){if(!s.chainId){const{network:e}=this.provider;s.chainId=e.chainId,s.scan=e.scan}s.pending=!0,this.queue.unshift(s),this.store.save(),this.provider.nonce=+s.nonce+1}delDelay(s,e=0){setTimeout(()=>this.del(s),e)}del(s){var c,a;const e=(a=(c=s.hash)!=null?c:s.ts)!=null?a:s;this.queue.some((r,n)=>{if([r.hash,r.ts,r].includes(e)){n===0&&(this.provider.nonce=0);const i=this.queue.splice(n,1);return this.store.save(),i}})}async check(s){this.queue.forEach(async(e,c)=>{if(s&&c===0){const a=await j(this.provider.account),r=+e.nonce;this.provider.nonce=r>a?r+1:a}if(e.done||new Date().getTime()-e.ts>=R)return this.del(e);if(!e.err&&!(!s&&e.pending)){e.pending=!0;try{const a=await this.provider.provider.waitForTransaction(e.hash),{status:r}=a;e.status=r,r===1?(e.done=!0,this.del(e)):e.err=!0}catch(a){e.err=a}e.pending=!1}}),this.store.save()}}const k={},y=(t=q.bridge.account)=>k[t]||(k[t]=new z(t)),J=async t=>t?{}:{};class ${constructor(s,{errorCodes:e="",seq:c=void 0,delay:a=0}={}){this.pending=!0,this.status=-1,this.txPromise=s,this.err=void 0,this.hash="",this.errorCodes=e,this.seq=c,this.delay=a}get success(){return this.status===1}get ignored(){return this.status===3}async wait(s=!1){return(async()=>{let e=!1;const c=await J(this.errorCodes);try{const a=await this.txPromise,{hash:r,nonce:n}=a;this.seq.nonce=n,this.seq&&(delete this.seq.overrides,y().add(Object.assign(this.seq,{hash:r}))),this.hash=r,this.status=2;const i=async()=>{const{status:o,events:h}=await a.wait(1);if(o!==1)throw this.seq&&(this.seq.err=!0),new Error("Failed");h.some(({event:l,args:C}={})=>{if(l==="Failure"){let{info:w,detail:p,error:f}=C;f=f.toString();const E={err:c[f],error:f,info:w==null?void 0:w.toString(),detail:p==null?void 0:p.toString()};throw this.seq&&(this.seq.err=!0),new Error(JSON.stringify(E))}}),this.status=1,this.seq&&(this.seq.done=!0),this.delay?y().delDelay(r,this.delay):y().del(r)};s?(e=!0,i()):await i()}catch(a){throw await P(a),this.status=0,a.code===4001&&(this.status=3),this.err=a,a}finally{this.pending=!1;const a=this.status===1;x.emit("tx-status",this.hash),a&&x.emit("tx-success",this.hash),e=a}return e})()}}const v={A:2,B:4,C:6},u=t=>[t,v[t]],G={"0x1":{"0x03783fac2efed8fbc9ad443e592ee30e61d65f471140c10ca155e937b435b760":u("A"),"0x1f675bff07515f5df96737194ea945c36c41e7b4fcef307b7cd4d0e602a69111":u("B"),"0x017e667f4b8c174291d1543c466717566e206df1bfd6f30271055ddafdb18f72":u("C")},"0xaa36a7":{"0x03783fac2efed8fbc9ad443e592ee30e61d65f471140c10ca155e937b435b760":u("A"),"0x1f675bff07515f5df96737194ea945c36c41e7b4fcef307b7cd4d0e602a69111":u("B"),"0x017e667f4b8c174291d1543c466717566e206df1bfd6f30271055ddafdb18f72":u("C")}},g=130,b=async()=>(await U()).bridge,K=async t=>t||(await b()).account,S=async()=>G[(await b()).network.current.chainId],V=async()=>Object.fromEntries(Object.entries(await S()).map(t=>[t[1][0],t[0]])),d=async t=>F("Locker",{account:await K(t)}),m=t=>t.replace(/^0x/,""),W=t=>`0x${m(t).slice(0,g)}`,B=t=>m(t).slice(g,g+1).toUpperCase(),X=t=>(t=m(t),parseInt(t.slice(g+1,t.length)||"0",16)),et=t=>{var s,e;return(e=v[(s=B(t))!=null?s:"C"])!=null?e:v.C},st=async t=>{const s=await b(),e=I(D(A("C"))),c=s.provider.getSigner(t||s.account);let a="";try{a=await c.signMessage(e)}catch(r){throw await P(r)}return[a.replace("0x",""),"c","0"].join("")},at=async t=>await(await d()).nameExists(t),rt=async(t,s=!1)=>await(await d(t))[s?"getUserPassesInfo":"getUserPassList"](t),Y=async t=>{const s=await d();let e="";try{e=await s.getNameByHash(I(t))}catch(c){}return e},ct=async(t,s)=>{var r;const e=await d(s),c=await S();let a={id:t,cate:"C",len:6,name:""};try{const[n,i,o]=await e.getUserPassInfo(t),h=(r=c[i])!=null?r:Object.values(a);a={id:n,cate:h[0],hash:o,len:h[1],name:await Y(o)}}catch(n){}return a},nt=async(t,s="")=>{let{id:e,code:c,cate:a}=t;const r=!!e;e||(c=W(t),a=(await V())[B(t)],e=X(t));const n=await d(),i=r?"lockName":"lockPass",o={},h=r?[+e,s]:[c,s,a,+e];await _(o,n,i,h);const l=n[i](...h);return new $(l,{seq:{type:r?"LockName":"lockPass",title:r?"Lock Name":"Lock Pass",ts:new Date().getTime(),overrides:o}})};export{st as a,ct as b,at as c,S as d,rt as e,Y as f,et as g,nt as l};
